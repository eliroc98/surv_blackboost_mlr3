---
title: "Survival Analysis with mlr3's Blackboost"
author: "Andrea Cutrera, Sonia Petrini, Elisabetta Rocchetti, Ruben Popper"
date: "5/28/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(survivalmodels)
library(mlr3proba); library(mlr3); library(survival)
library(mlr3misc)
library(survival)
library(mboost)
library(mlr3learners)
library(mlr3extralearners)
```

## Dataset

The aim of this report is to perform Survival Analysis on the German Breast Cancer Study (GBCS) Dataset from Hosmer et al. 
The machine learning tool that will be implemented is the mlr3 extra learner "surv.blackboost" (documentation available at: [mlr_learners_surv.blackboost](https://rdrr.io/github/mlr-org/mlr3extralearners/man/mlr_learners_surv.blackboost.html)), 
which combines a CART algorithm with Gradient Boosting.

This method calls blackboost from the mboost package 



The structure of the data is the following:
  - observations: 686 - patients with primary node positive breast cancer.
  - variables: 16 - biological factors concerning patients and tumor severity.
  
The Survival Analysis' dimensions are stored in these variables:
  - censdead: Censoring status. 1 = Death. 0 = Censored.
  - survtime: Time to death (days).
  

  

  
  

```{r}
description <- c("Identification Code.","Date of diagnosis.","Date of recurrence free survival.","Date of death.","Age at diagnosis (years).",
           "Menopausal status. 1 = Yes, 0 = No.", "Hormone therapy. 1 = Yes. 0 = No.","Tumor size (mm).","Tumor grade (1-3).","Number of nodes.",
           "Number of progesterone receptors.","Number of estrogen receptors.","Time to recurrence (days).","Recurrence status. 1 = Recurrence. 0 = Censored.", "Time to death (days).", "Censoring status. 1 = Death. 0 = Censored.")
data.frame("variable" = colnames(gbcs),description)
```



```{r cars}
#load dataset
gbcs <- mlr3proba::gbcs

#select relevant variables 
gbcs <- gbcs[,c(5:12,15:16)]
summarytools::dfSummary(gbcs, 
                        graph.col = F, 
                        valid.col = F
)
```
## surv_blackboost_mlr3 

The function `surv.blackboost` implements a gradient boosting algorithm that can be fitted for censored data. Similarly to other packages, blackboost implements the classical algorithm with regression trees as base learners. The peculiarity of blackboost is the possibility to change the default loss function to be optimized for the terminal regions of each tree. Blackboost allows to do so either by specifying a custom loss function or by selecting a pre-existing one under the `family` argument. Moreover, the performances of the model can be implemented further by specifying a variety of tree controls. In fact, blackboost relies on `partykit::ctree`, which offers a wide range of parameters for conditional inference trees. You can type `args(partykit::ctree_control)` for more details on the tree controls parameters.

`mlr3` offers an intuitive and interconnected set of extension packages that we are going to use with respect to different aspects of this explanatory project.
We can start off by installing all the required packages:

``` {r, eval=FALSE}
install.packages(c("mlr3", "mlr3learners", "mlr3extralearners", "mlr3tuning", "mlr3proba", "mlr3pipelines", "mlr3misc", "survivalmodels", "mboost", "paradox", "parallell", "stabs"), repos = "http://cran.us.r-project.org")
```
___

### Packages Overview
Let us briefly discuss the role of some of the packages in *mlr3*. `mlr3learners` and `mlr3extralearners` include a collection of machine learning algorithms to perform classification, regression, clustering, density clustering and survival analysis task (available at [mlr3learners](https://mlr3extralearners.mlr-org.com/articles/learners/list_learners.html)). In order to tell R what type of data we are dealing with we use `mlr3proba`. This package facilitates our job in many ways since it allows us to datasets in tasks of which it recognizes the main features. After importing and preprocessing our datasets, we can set `TaskSurv` in order to let R consider censored observation (more code examples are provided below).

Before moving on with the next topic, let us dive deeper in the functionality of blackboost by taking a look at its parameters and their respective default values:

```{r, echo=FALSE} 
library(mlr3extralearners)
install_learners('surv.blackboost')
learner = lrn("surv.blackboost")
learner$param_set$ids()
```
___


## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
